{# Dashboard Enhanced - Style Velzon #}
{% extends 'layouts/main.html.twig' %}
{% block title %}Dashboard{% endblock %}

{# Badge statut sans constant() #}
{% macro status_badge(s) %}
  {% set map = {
    'HONORE':   'bg-success-subtle text-success',
    'CONFIRME': 'bg-primary-subtle text-primary',
    'ANNULE':   'bg-danger-subtle text-danger',
    'ABSENT':   'bg-warning-subtle text-warning',
    'PLANIFIE': 'bg-info-subtle text-info'
  } %}
  <span class="badge {{ map[s] ?? 'bg-info-subtle text-info' }}">{{ s }}</span>
{% endmacro %}

{% block stylesheets %}
<style>
.stat-card {
    transition: all 0.3s ease;
    border-left: 3px solid transparent;
}
.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15) !important;
}
.stat-card.primary { border-left-color: #0d6efd; }
.stat-card.success { border-left-color: #198754; }
.stat-card.warning { border-left-color: #ffc107; }
.stat-card.danger { border-left-color: #dc3545; }
.stat-card.info { border-left-color: #0dcaf0; }

.payment-progress-mini {
    height: 4px;
    border-radius: 2px;
    background-color: #f0f0f0;
    overflow: hidden;
    margin-top: 4px;
}
.payment-progress-bar-mini {
    height: 100%;
    background: linear-gradient(90deg, #ffc107 0%, #ff9800 100%);
}
</style>
{% endblock %}

{% block page_header %}
  <div class="row">
    <div class="col-12">
      <div class="page-title-box d-sm-flex align-items-center justify-content-between">
        <div>
          <h4 class="mb-sm-0">Tableau de bord</h4>
          <p class="text-muted mb-0">Bienvenue, voici votre activité aujourd'hui</p>
        </div>
        <div class="page-title-right">
          <ol class="breadcrumb m-0">
            <li class="breadcrumb-item active">Dashboard</li>
          </ol>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block body %}
  {# SECTION 1: KPIs Aujourd'hui #}
  <div class="row">
    <div class="col-xl-3 col-md-6">
      <div class="card card-animate stat-card primary">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="flex-grow-1 overflow-hidden">
              <p class="text-uppercase fw-medium text-muted text-truncate mb-0">CA du Jour</p>
            </div>
            <div class="flex-shrink-0">
              <h5 class="text-success fs-14 mb-0">
                <i class="ri-arrow-right-up-line fs-13 align-middle"></i>
              </h5>
            </div>
          </div>
          <div class="d-flex align-items-end justify-content-between mt-4">
            <div>
              <h4 class="fs-22 fw-semibold ff-secondary mb-2">
                <span class="counter-value" data-target="{{ kpis.caToday }}">{{ kpis.caToday|number_format(0, ',', ' ') }}</span>
                <small class="text-muted fs-13"> MRU</small>
              </h4>
              <a href="{{ path('cash_index') }}" class="text-decoration-underline text-muted">Voir la caisse</a>
            </div>
            <div class="avatar-sm flex-shrink-0">
              <span class="avatar-title bg-success-subtle rounded fs-3">
                <i class="ri-money-dollar-circle-line text-success"></i>
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6">
      <div class="card card-animate stat-card info">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="flex-grow-1 overflow-hidden">
              <p class="text-uppercase fw-medium text-muted text-truncate mb-0">RDV Aujourd'hui</p>
            </div>
          </div>
          <div class="d-flex align-items-end justify-content-between mt-4">
            <div>
              <h4 class="fs-22 fw-semibold ff-secondary mb-2">
                <span class="counter-value" data-target="{{ kpis.rdv }}">{{ kpis.rdv }}</span>
              </h4>
              <a href="{{ path('app_rdv_index') }}" class="text-decoration-underline text-muted">Liste des RDV</a>
            </div>
            <div class="avatar-sm flex-shrink-0">
              <span class="avatar-title bg-info-subtle rounded fs-3">
                <i class="ri-calendar-check-line text-info"></i>
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6">
      <div class="card card-animate stat-card success">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="flex-grow-1 overflow-hidden">
              <p class="text-uppercase fw-medium text-muted text-truncate mb-0">Honorés</p>
            </div>
          </div>
          <div class="d-flex align-items-end justify-content-between mt-4">
            <div>
              <h4 class="fs-22 fw-semibold ff-secondary mb-2">
                <span class="counter-value" data-target="{{ kpis.honores }}">{{ kpis.honores }}</span>
                <small class="text-muted fs-13">/ {{ kpis.rdv }}</small>
              </h4>
              {% set tauxHonore = kpis.rdv > 0 ? (kpis.honores / kpis.rdv * 100) : 0 %}
              <span class="badge bg-success-subtle text-success mb-0">{{ tauxHonore|round(1) }}%</span>
            </div>
            <div class="avatar-sm flex-shrink-0">
              <span class="avatar-title bg-success-subtle rounded fs-3">
                <i class="ri-checkbox-circle-line text-success"></i>
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6">
      <div class="card card-animate stat-card danger">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="flex-grow-1 overflow-hidden">
              <p class="text-uppercase fw-medium text-muted text-truncate mb-0">Annulés / Absents</p>
            </div>
          </div>
          <div class="d-flex align-items-end justify-content-between mt-4">
            <div>
              <h4 class="fs-22 fw-semibold ff-secondary mb-2">
                <span class="counter-value" data-target="{{ kpis.annules + kpis.absents }}">{{ kpis.annules + kpis.absents }}</span>
              </h4>
              <span class="badge bg-danger-subtle text-danger">{{ kpis.annules }} annulés</span>
              <span class="badge bg-secondary-subtle text-secondary">{{ kpis.absents }} no-show</span>
            </div>
            <div class="avatar-sm flex-shrink-0">
              <span class="avatar-title bg-danger-subtle rounded fs-3">
                <i class="ri-close-circle-line text-danger"></i>
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {# SECTION 2: Actions Rapides #}
  <div class="row">
    <div class="col-12">
      <div class="card card-animate">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between">
            <h5 class="card-title mb-0">
              <i class="ri-flashlight-line align-middle me-1 text-primary"></i>
              Actions Rapides
            </h5>
          </div>
          <div class="row g-3 mt-2">
            <div class="col-lg-3 col-md-6">
              <a href="{{ path('app_rdv_new') }}" class="btn btn-soft-primary w-100 btn-lg">
                <i class="ri-add-circle-line align-middle me-2 fs-16"></i>
                Nouveau RDV
              </a>
            </div>
            <div class="col-lg-3 col-md-6">
              <a href="{{ path('agenda') }}" class="btn btn-soft-info w-100 btn-lg">
                <i class="ri-calendar-line align-middle me-2 fs-16"></i>
                Agenda
              </a>
            </div>
            <div class="col-lg-3 col-md-6">
              <a href="{{ path('cash_index') }}" class="btn btn-soft-success w-100 btn-lg">
                <i class="ri-wallet-3-line align-middle me-2 fs-16"></i>
                Caisse
              </a>
            </div>
            <div class="col-lg-3 col-md-6">
              <a href="{{ path('app_client_index') }}" class="btn btn-soft-secondary w-100 btn-lg">
                <i class="ri-user-add-line align-middle me-2 fs-16"></i>
                Nouveau Client
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {# SECTION 3: Rendez-vous partiellement payés (Alerte) #}
  {% if partiallyPaidCount > 0 %}
  <div class="row">
    <div class="col-12">
      <div class="card border-warning">
        <div class="card-header bg-warning-subtle border-warning">
          <div class="d-flex align-items-center">
            <div class="flex-grow-1">
              <h4 class="card-title mb-0">
                <i class="ri-alert-line text-warning me-2"></i>
                Paiements à compléter
              </h4>
            </div>
            <div class="flex-shrink-0">
              <span class="badge bg-warning fs-13 me-2">
                {{ partiallyPaidCount }} RDV en attente
              </span>
              <a href="{{ path('app_rdv_partial_payments') }}" class="btn btn-warning btn-sm">
                <i class="ri-eye-line me-1"></i>
                Voir tous
              </a>
            </div>
          </div>
        </div>
        <div class="card-body">
          <p class="text-muted mb-3">
            <i class="ri-information-line me-1"></i>
            Ces rendez-vous ont reçu un paiement partiel et nécessitent un complément.
          </p>
          <div class="table-responsive table-card">
            <table class="table table-borderless table-centered align-middle table-nowrap mb-0">
              <thead class="text-muted table-light">
                <tr>
                  <th scope="col">Client</th>
                  <th scope="col">Prestation</th>
                  <th scope="col">Date</th>
                  <th scope="col">Total</th>
                  <th scope="col">Payé</th>
                  <th scope="col" class="text-danger">Restant</th>
                  <th scope="col">Progression</th>
                  <th scope="col">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for rdv in partiallyPaidRdvs %}
                  {% set percentPaid = rdv.totalAmount > 0 ? (rdv.totalPaid / rdv.totalAmount * 100)|round : 0 %}
                  <tr>
                    <td>
                      <div class="d-flex align-items-center">
                        <div class="avatar-xs me-2">
                          <span class="avatar-title rounded-circle bg-warning-subtle text-warning">
                            <i class="ri-user-line"></i>
                          </span>
                        </div>
                        <div>
                          <h6 class="mb-0">{{ rdv.client.nometprenom }}</h6>
                          <small class="text-muted">{{ rdv.client.telephone }}</small>
                        </div>
                      </div>
                    </td>
                    <td>
                      <span class="fw-medium">{{ rdv.prestation.libelle }}</span>
                    </td>
                    <td>
                      <span class="text-muted">{{ rdv.startAt ? rdv.startAt|date('d/m/Y') : '—' }}</span><br>
                      <small class="text-muted">{{ rdv.startAt ? rdv.startAt|date('H:i') : '—' }}</small>
                    </td>
                    <td>
                      <span class="fw-semibold">{{ rdv.totalAmount|number_format(0, ',', ' ') }}</span>
                      <small class="text-muted">MRU</small>
                    </td>
                    <td>
                      <span class="text-success fw-medium">{{ rdv.totalPaid|number_format(0, ',', ' ') }}</span>
                      <small class="text-muted">MRU</small>
                    </td>
                    <td>
                      <span class="badge bg-danger-subtle text-danger fs-13">
                        {{ rdv.remainingAmount|number_format(0, ',', ' ') }} MRU
                      </span>
                    </td>
                    <td style="min-width: 100px;">
                      <div class="payment-progress-mini">
                        <div class="payment-progress-bar-mini" style="width: {{ percentPaid }}%"></div>
                      </div>
                      <small class="text-muted">{{ percentPaid }}%</small>
                    </td>
                    <td class="text-end">
                      <div class="btn-group">
                        <a class="btn btn-sm btn-soft-secondary" href="{{ path('app_rdv_show', {id: rdv.id}) }}" title="Détails">
                          <i class="ri-eye-line"></i>
                        </a>
                        <a class="btn btn-sm btn-warning" href="{{ path('app_payment_new', { rdv: rdv.id }) }}" title="Compléter le paiement">
                          <i class="ri-cash-line me-1"></i>
                          Payer
                        </a>
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% if partiallyPaidCount > 5 %}
          <div class="text-center mt-3">
            <a href="{{ path('app_rdv_partial_payments') }}" class="btn btn-soft-warning">
              <i class="ri-arrow-right-line me-1"></i>
              Voir les {{ partiallyPaidCount - 5 }} autres rendez-vous
            </a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  {# SECTION 4: Graphique CA 30 jours #}
  <div class="row">
    <div class="col-xl-12">
      <div class="card">
        <div class="card-header border-0 align-items-center d-flex">
          <h4 class="card-title mb-0 flex-grow-1">
            <i class="ri-line-chart-line align-middle me-1 text-primary"></i>
            Évolution du CA — 30 derniers jours
          </h4>
        </div>
        <div class="card-body p-0 pb-2">
          <div class="w-100">
            <div id="chart-revenue-30" style="min-height: 320px;" class="apex-charts" dir="ltr"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {# SECTION 5: Statuts RDV + Top Prestations #}
  <div class="row">
    {# Statuts RDV (Semaine) #}
    <div class="col-xl-5">
      <div class="card card-height-100">
        <div class="card-header align-items-center d-flex">
          <h4 class="card-title mb-0 flex-grow-1">
            <i class="ri-pie-chart-2-line align-middle me-1 text-info"></i>
            Statuts RDV (Cette semaine)
          </h4>
        </div>
        <div class="card-body">
          <div id="chart-status-week" style="min-height: 300px;" class="apex-charts" dir="ltr"></div>
          
          {# Légende détaillée #}
          <div class="mt-3">
            <div class="d-flex justify-content-between border-bottom pb-2 mb-2">
              <div class="d-flex align-items-center">
                <span class="badge bg-primary-subtle text-primary rounded-circle p-2 me-2">●</span>
                <span class="text-muted">Planifiés</span>
              </div>
              <span class="fw-semibold">{{ statusWeek.PLANIFIE ?? 0 }}</span>
            </div>
            <div class="d-flex justify-content-between border-bottom pb-2 mb-2">
              <div class="d-flex align-items-center">
                <span class="badge bg-info-subtle text-info rounded-circle p-2 me-2">●</span>
                <span class="text-muted">Confirmés</span>
              </div>
              <span class="fw-semibold">{{ statusWeek.CONFIRME ?? 0 }}</span>
            </div>
            <div class="d-flex justify-content-between border-bottom pb-2 mb-2">
              <div class="d-flex align-items-center">
                <span class="badge bg-success-subtle text-success rounded-circle p-2 me-2">●</span>
                <span class="text-muted">Honorés</span>
              </div>
              <span class="fw-semibold">{{ statusWeek.HONORE ?? 0 }}</span>
            </div>
            <div class="d-flex justify-content-between border-bottom pb-2 mb-2">
              <div class="d-flex align-items-center">
                <span class="badge bg-danger-subtle text-danger rounded-circle p-2 me-2">●</span>
                <span class="text-muted">Annulés</span>
              </div>
              <span class="fw-semibold">{{ statusWeek.ANNULE ?? 0 }}</span>
            </div>
            <div class="d-flex justify-content-between">
              <div class="d-flex align-items-center">
                <span class="badge bg-secondary-subtle text-secondary rounded-circle p-2 me-2">●</span>
                <span class="text-muted">Absents</span>
              </div>
              <span class="fw-semibold">{{ statusWeek.ABSENT ?? 0 }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    {# Top Prestations #}
    <div class="col-xl-7">
      <div class="card card-height-100">
        <div class="card-header align-items-center d-flex">
          <h4 class="card-title mb-0 flex-grow-1">
            <i class="ri-bar-chart-2-line align-middle me-1 text-warning"></i>
            Top Prestations (CA — Ce mois)
          </h4>
          <div class="flex-shrink-0">
            <a href="{{ path('stats_index') }}" class="btn btn-soft-primary btn-sm">
              <i class="ri-eye-line align-middle me-1"></i> Voir tout
            </a>
          </div>
        </div>
        <div class="card-body">
          <div id="chart-top-prestations" style="min-height: 300px;" class="apex-charts" dir="ltr"></div>
        </div>
      </div>
    </div>
  </div>

  {# SECTION 6: Activité Récente #}
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header align-items-center d-flex">
          <h4 class="card-title mb-0 flex-grow-1">
            <i class="ri-history-line align-middle me-1 text-muted"></i>
            Activité Récente
          </h4>
          <div class="flex-shrink-0">
            <a href="{{ path('app_rdv_index') }}" class="btn btn-soft-info btn-sm">Tout voir</a>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive table-card">
            <table class="table table-borderless table-centered align-middle table-nowrap mb-0">
              <thead class="text-muted table-light">
                <tr>
                  <th scope="col">Client</th>
                  <th scope="col">Prestation</th>
                  <th scope="col">Date/Heure</th>
                  <th scope="col">Statut</th>
                  <th scope="col">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for rdv in recentRdvs %}
                  <tr>
                    <td>{{ rdv.client }}</td>
                    <td>{{ rdv.prestation }}</td>
                    <td>
                      {{ rdv.startAt ? rdv.startAt|date('d/m/Y H:i') : '—' }}
                      {% if rdv.endAt %}— {{ rdv.endAt|date('H:i') }}{% endif %}
                    </td>
                    <td>{{ _self.status_badge(rdv.status) }}</td>
                    <td class="text-end">
                      <div class="btn-group">
                        <a class="btn btn-sm btn-soft-secondary" href="{{ path('app_rdv_show', {id: rdv.id}) }}">
                          <i class="ri-eye-line"></i>
                        </a>
                        <a class="btn btn-sm btn-soft-info" href="{{ path('app_rdv_edit', {id: rdv.id}) }}">
                          <i class="ri-pencil-line"></i>
                        </a>
                        {% if rdv.remainingAmount > 0 %}
                          <a class="btn btn-sm btn-soft-success" href="{{ path('app_payment_new', { rdv: rdv.id }) }}">
                            <i class="ri-cash-line"></i>
                          </a>
                        {% else %}
                          <a class="btn btn-sm btn-soft-success disabled" href="#" title="Payé">
                            <i class="ri-check-line"></i>
                          </a>
                        {% endif %}
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block javascripts %}
  <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.45.1/dist/apexcharts.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const labels30   = {{ labels30|json_encode|raw }};
      const values30   = {{ values30|json_encode|raw }};
      const statusWeek = {{ statusWeek|json_encode|raw }};
      const topLabels  = {{ topLabels|json_encode|raw }};
      const topValues  = {{ topValues|json_encode|raw }};

      const getChartColorsArray = (colors) => {
        colors = JSON.parse(colors);
        return colors.map(function(value) {
          var newValue = value.replace(" ", "");
          if (newValue.indexOf(",") === -1) {
            var color = getComputedStyle(document.documentElement).getPropertyValue(newValue);
            if (color.indexOf("#") !== -1) color = color.replace(" ", "");
            if (color) return color;
            else return newValue;
          }
        });
      };

      // 1) CA 30 jours
      try {
        const chart1Colors = '["--vz-primary", "--vz-success"]';
        const chart1 = new ApexCharts(document.querySelector("#chart-revenue-30"), {
          chart: { height: 320, type: 'area', toolbar: { show: false }},
          dataLabels: { enabled: false },
          stroke: { curve: 'smooth', width: 3 },
          series: [{ name: 'Chiffre d\'affaires', data: values30 }],
          fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.5, opacityTo: 0.1 }},
          xaxis: { categories: labels30, labels: { rotate: -45 }},
          yaxis: { labels: { formatter: (v) => Intl.NumberFormat('fr-FR').format(v) }},
          colors: getChartColorsArray(chart1Colors),
          tooltip: { y: { formatter: (v) => Intl.NumberFormat('fr-FR').format(v) + ' MRU' }}
        });
        chart1.render();
      } catch (e) { console.error('Erreur chart CA:', e); }

      // 2) Statuts semaine
      try {
        const statutLabels = ['PLANIFIE', 'CONFIRME', 'HONORE', 'ANNULE', 'ABSENT'];
        const statutValues = statutLabels.map(s => statusWeek[s] ?? 0);
        if (statutValues.some(v => v > 0)) {
          const chart2Colors = '["--vz-primary", "--vz-info", "--vz-success", "--vz-danger", "--vz-secondary"]';
          const chart2 = new ApexCharts(document.querySelector("#chart-status-week"), {
            series: statutValues,
            labels: ['Planifiés', 'Confirmés', 'Honorés', 'Annulés', 'Absents'],
            chart: { type: 'donut', height: 300 },
            plotOptions: { pie: { donut: { size: "70%" }}},
            dataLabels: { enabled: false },
            legend: { show: false },
            colors: getChartColorsArray(chart2Colors)
          });
          chart2.render();
        } else {
          document.querySelector("#chart-status-week").innerHTML = '<div class="text-center text-muted py-5">Aucun RDV cette semaine</div>';
        }
      } catch (e) { console.error('Erreur chart statuts:', e); }

      // 3) Top prestations
      try {
        if (topLabels.length > 0) {
          const chart3Colors = '["--vz-warning"]';
          const chart3 = new ApexCharts(document.querySelector("#chart-top-prestations"), {
            series: [{ name: 'CA', data: topValues }],
            chart: { type: 'bar', height: 300, toolbar: { show: false }},
            plotOptions: { bar: { borderRadius: 8, columnWidth: '60%' }},
            dataLabels: { enabled: false },
            xaxis: { categories: topLabels, labels: { rotate: -45 }},
            yaxis: { labels: { formatter: (v) => Intl.NumberFormat('fr-FR').format(v) }},
            colors: getChartColorsArray(chart3Colors),
            tooltip: { y: { formatter: (v) => Intl.NumberFormat('fr-FR').format(v) + ' MRU' }}
          });
          chart3.render();
        } else {
          document.querySelector("#chart-top-prestations").innerHTML = '<div class="text-center text-muted py-5">Aucune prestation ce mois</div>';
        }
      } catch (e) { console.error('Erreur chart top:', e); }
    });
  </script>
{% endblock %}
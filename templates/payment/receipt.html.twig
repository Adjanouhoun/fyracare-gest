{# templates/payment/receipt.html.twig #}
{% extends 'layouts/main.html.twig' %}
{% block title %}Reçu
	{{ payment.receiptNumber }}
	| Fyracare
{% endblock %}

{% block page_header %}
	<div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
		<div>
			<h4 class="fs-16 mb-1">Reçu de paiement</h4>
			<p class="text-muted mb-0">N°
				{{ payment.receiptNumber }}</p>
		</div>
		<div class="d-print-none">
			<a href="{{ path('app_payment_receipt_pdf', { id: payment.id }) }}" class="btn btn-primary">
				<i class="ri-printer-line align-middle me-1"></i>
				Imprimer (PDF)
			</a>
			<a href="{{ path('app_rdv_show', { id: payment.rdv.id }) }}" class="btn btn-ghost-secondary">Voir le RDV</a>
		</div>
	</div>
{% endblock %}

{% block body %}
	<div class="card">
		<div class="card-body">
			{# --- ENTÊTE: Logo + Coordonnées + Meta reçu --- #}
			<div class="row align-items-center mb-4">
				<div class="col-sm-6 d-flex align-items-center gap-3">
					{% if app_settings.get().logoInvoicePath %}
						<img src="{{ asset(app_settings.get().logoInvoicePath) }}" alt="Logo" style="height:48px">
					{% else %}
						<div class="avatar-md">
							<span class="avatar-title bg-primary-subtle text-primary rounded fs-22">F</span>
						</div>
					{% endif %}
					<div>
						<h5 class="mb-1">Fyracare</h5>
						<div class="text-muted small">
							{{ app_settings.get().address ?: '—' }}<br>
							Tél :
							{{ app_settings.get().phone ?: '—' }}
							— Email :
							{{ app_settings.get().email ?: '—' }}
						</div>
					</div>
				</div>

				<div class="col-sm-6 text-sm-end mt-3 mt-sm-0">
					<div class="text-muted">Reçu n°</div>
					<h4 class="mb-1">{{ payment.receiptNumber }}</h4>
					<div class="text-muted">Payé le
						{{ payment.paidAt|date('d/m/Y H:i') }}</div>
					<div class="text-muted">Méthode :
						<span class="fw-medium">{{ payment.methode }}</span>
					</div>
				</div>
			</div>

			{# --- LIGNES: Bill To + Détails RDV --- #}
			<div class="row mb-4">
				<div class="col-md-6">
					<h6 class="text-uppercase text-muted mb-2">Client</h6>
					<div class="fw-medium">{{ payment.rdv.client.nometprenom }}</div>
					<div class="text-muted">{{ payment.rdv.client.telephone ?: '—' }}</div>
					<div class="text-muted">{{ payment.rdv.client.email ?: '—' }}</div>
				</div>
				<div class="col-md-6 mt-3 mt-md-0 text-md-end">
					<h6 class="text-uppercase text-muted mb-2">Rendez-vous</h6>
					<div>Prestation :
						<strong>{{ payment.rdv.prestation.libelle }}</strong>
					</div>
					<div>Début :
						{{ payment.rdv.startAt|date('d/m/Y H:i') }}</div>
					<div>Fin :
						{{ payment.rdv.endAt|date('d/m/Y H:i') }}</div>
				</div>
			</div>

			{# --- TABLEAU ARTICLES (1 ligne) + TOTALS --- #}
			<div class="table-responsive mb-3">
				<table class="table table-bordered mb-0">
					<thead class="table-light">
						<tr>
							<th style="width: 70%">Description</th>
							<th class="text-end" style="width: 30%">Montant (MRU)</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td>
								{{ payment.rdv.prestation.libelle }}
								<div class="text-muted small">
									RDV du
									{{ payment.rdv.startAt|date('d/m/Y H:i') }}
									—
									{{ payment.rdv.endAt|date('H:i') }}
								</div>
								{# Indication du type de paiement #}
								<div class="mt-2">
									{% if payment.isDeposit %}
										<span class="badge bg-info">Acompte</span>
									{% else %}
										<span class="badge bg-success">Paiement final</span>
									{% endif %}
								</div>
							</td>
							<td class="text-end">{{ payment.amount|number_format(0, ',', ' ') }}</td>
						</tr>
					</tbody>
					<tfoot>
						<tr>
							<th class="text-end">Montant du paiement</th>
							<th class="text-end">{{ payment.amount|number_format(0, ',', ' ') }}</th>
						</tr>
					</tfoot>
				</table>
			</div>

			{# --- STATUT DU PAIEMENT --- #}
			<div class="card bg-light border mb-3">
				<div class="card-body">
					<div class="row">
						<div class="col-md-6">
							<h6 class="text-uppercase text-muted mb-3">Statut du paiement</h6>
							<div class="d-flex justify-content-between mb-2">
								<span>Prix total de la prestation :</span>
								<strong>{{ payment.rdv.totalAmount|number_format(0, ',', ' ') }} MRU</strong>
							</div>
							<div class="d-flex justify-content-between mb-2">
								<span>Total payé (cumulé) :</span>
								<strong class="text-success">{{ payment.rdv.totalPaid|number_format(0, ',', ' ') }} MRU</strong>
							</div>
							<div class="d-flex justify-content-between mb-2">
								<span>Reste à payer :</span>
								<strong class="{{ payment.rdv.remainingAmount > 0 ? 'text-danger' : 'text-success' }}">
									{{ payment.rdv.remainingAmount|number_format(0, ',', ' ') }} MRU
								</strong>
							</div>
						</div>
						<div class="col-md-6 d-flex align-items-center justify-content-center">
							{% if payment.rdv.paymentStatus == constant('App\\Entity\\Rdv::PS_PAYE') %}
								<div class="text-center">
									<div class="avatar-lg mx-auto mb-2">
										<span class="avatar-title bg-success-subtle text-success rounded-circle fs-22">
											<i class="ri-checkbox-circle-line"></i>
										</span>
									</div>
									<h5 class="text-success mb-0">Paiement complet</h5>
									<p class="text-muted small mb-0">La prestation est entièrement payée</p>
								</div>
							{% elseif payment.rdv.paymentStatus == constant('App\\Entity\\Rdv::PS_PARTIEL') %}
								<div class="text-center">
									<div class="avatar-lg mx-auto mb-2">
										<span class="avatar-title bg-warning-subtle text-warning rounded-circle fs-22">
											<i class="ri-time-line"></i>
										</span>
									</div>
									<h5 class="text-warning mb-0">Paiement partiel</h5>
									<p class="text-muted small mb-0">{{ payment.rdv.remainingAmount|number_format(0, ',', ' ') }} MRU reste à payer</p>
								</div>
							{% else %}
								<div class="text-center">
									<div class="avatar-lg mx-auto mb-2">
										<span class="avatar-title bg-secondary-subtle text-secondary rounded-circle fs-22">
											<i class="ri-error-warning-line"></i>
										</span>
									</div>
									<h5 class="text-secondary mb-0">Non payé</h5>
									<p class="text-muted small mb-0">Aucun paiement enregistré</p>
								</div>
							{% endif %}
						</div>
					</div>
				</div>
			</div>

			{# --- NOTES (si présentes) --- #}
			{% if payment.notes %}
				<div class="alert alert-secondary bg-secondary-subtle text-secondary border-0">
					<div class="fw-semibold mb-1 text-uppercase small">Notes</div>
					<div class="text-body">{{ payment.notes }}</div>
				</div>
			{% endif %}

			{# --- PIED DE PAGE --- #}
			<div class="mt-4 d-flex flex-column flex-sm-row align-items-sm-center justify-content-between">
				<div class="small text-muted">Merci pour votre confiance.</div>
				<div class="small text-muted">Reçu généré le
					{{ "now"|date('d/m/Y H:i') }}</div>
			</div>
		</div>
	</div>

	<style>
		@media print {
			header#page-topbar,
			.app-menu,
			.footer,
			.layout-rightside,
			.d-print-none {
				display: none !important;
			}
			.main-content,
			.page-content,
			.container-fluid {
				margin: 0 !important;
				padding: 0 !important;
			}
			.card {
				box-shadow: none !important;
				border: 0 !important;
			}
			body {
				-webkit-print-color-adjust: exact;
				print-color-adjust: exact;
			}
		}
	</style>
{% endblock %}

{% extends 'layouts/main.html.twig' %}
{% block title %}Prestations | Velzon{% endblock %}

{% block page_header %}
<div class="row mb-3 pb-1">
  <div class="col-12 d-flex align-items-center justify-content-between flex-wrap gap-2">
    <div>
      <h4 class="fs-16 mb-1">Prestations</h4>
      <p class="text-muted mb-0">Catalogue des prestations</p>
    </div>

    <div class="d-flex align-items-center gap-2">
      <form method="get" action="{{ path('app_prestation_index') }}" class="d-flex align-items-center gap-2">
        <div class="input-group">
          <input type="text" class="form-control" name="q"
                 placeholder="Rechercher (libellé, description)"
                 value="{{ q|default('') }}">
          <select name="status" class="form-select">
            <option value="" {{ status is empty ? 'selected' : '' }}>Tous</option>
            <option value="active" {{ status == 'active' ? 'selected' : '' }}>Actifs</option>
            <option value="inactive" {{ status == 'inactive' ? 'selected' : '' }}>Inactifs</option>
          </select>
          <button class="btn btn-outline-secondary" type="submit">
            <i class="ri-search-line"></i>
          </button>
          {% if (q|default('') != '') or (status|default('') != '') %}
            <a class="btn btn-outline-dark" href="{{ path('app_prestation_index') }}" title="Effacer">
              <i class="ri-close-line"></i>
            </a>
          {% endif %}
        </div>
      </form>

      <a href="{{ path('app_prestation_new') }}" class="btn btn-primary">
        <i class="ri-add-circle-line align-middle me-1"></i> Nouvelle prestation
      </a>
    </div>
  </div>
</div>
{% endblock %}

{% block body %}
<div class="card">
  <div class="card-body">
    {% include 'partials/flashes.html.twig' %}

    {% if q or status %}
      <div class="mb-2 text-muted">
        Résultats
        {% if q %} pour <span class="fw-semibold">“{{ q }}”</span>{% endif %}
        {% if status == 'active' %} — <span class="badge bg-success-subtle text-success">actifs</span>{% endif %}
        {% if status == 'inactive' %} — <span class="badge bg-danger-subtle text-danger">inactifs</span>{% endif %}
      </div>
    {% endif %}

    <div class="table-responsive table-card">
      <table class="table table-hover align-middle table-nowrap mb-0">
        <thead class="table-light">
          <tr>
            <th>Libellé</th>
            <th class="text-center">Durée</th>
            <th class="text-center">Prix</th>
            <th class="text-center">Statut</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
        {% for p in pagination %}
          <tr id="row-{{ p.id }}">
            <td class="fw-medium">{{ p.libelle }}</td>
            <td class="text-center">{{ p.dureeMin }} min</td>
            <td class="text-center">{{ p.prix|number_format(0, ',', ' ') }} MRU</td>
            <td class="text-center">
              <div class="form-check form-switch d-inline-flex align-items-center gap-2">
                <input
                  class="form-check-input toggle-active"
                  type="checkbox"
                  role="switch"
                  id="switch-{{ p.id }}"
                  data-url="{{ path('app_prestation_toggle', {id: p.id}) }}"
                  data-token="{{ csrf_token('toggle' ~ p.id) }}"
                  {% if p.isActive %}checked{% endif %}>
                <label for="switch-{{ p.id }}" class="form-check-label">
                  <span class="badge status-badge {{ p.isActive ? 'bg-success-subtle text-success' : 'bg-danger-subtle text-danger' }}">
                    {{ p.isActive ? 'Actif' : 'Inactif' }}
                  </span>
                </label>
              </div>
            </td>
            <td class="text-end">
              <a href="{{ path('app_prestation_show', {id: p.id}) }}" class="btn btn-sm btn-soft-info">
                <i class="ri-eye-line"></i> Voir
              </a>
              <a href="{{ path('app_prestation_edit', {id: p.id}) }}" class="btn btn-sm btn-soft-secondary">
                <i class="ri-pencil-line"></i> Modifier
              </a>
              <form method="post" action="{{ path('app_prestation_delete', {id: p.id}) }}" class="d-inline"
                    onsubmit="return confirm('Supprimer cette prestation ?');">
                <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ p.id) }}">
                <button class="btn btn-sm btn-soft-danger">
                  <i class="ri-delete-bin-line"></i> Supprimer
                </button>
              </form>
            </td>
          </tr>
        {% else %}
          <tr><td colspan="5" class="text-center text-muted">Aucune prestation.</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="mt-3 d-flex justify-content-center">
      {{ knp_pagination_render(pagination) }}
    </div>
  </div>
</div>

{# JS minimal pour le toggle AJAX #}
<script>
document.addEventListener('DOMContentLoaded', function () {
  document.querySelectorAll('.toggle-active').forEach(function (checkbox) {
    checkbox.addEventListener('change', async function () {
      const url = this.dataset.url;
      const token = this.dataset.token;
      const row = this.closest('tr');
      const badge = row.querySelector('.status-badge');
      const checked = this.checked;

      try {
        const form = new FormData();
        form.append('_token', token);

        const res = await fetch(url, { method: 'POST', body: form, headers: { 'X-Requested-With': 'XMLHttpRequest' } });
        const json = await res.json();

        if (!json.ok) throw new Error(json.message || 'Erreur');

        if (json.active) {
          badge.classList.remove('bg-danger-subtle','text-danger');
          badge.classList.add('bg-success-subtle','text-success');
          badge.textContent = 'Actif';
        } else {
          badge.classList.remove('bg-success-subtle','text-success');
          badge.classList.add('bg-danger-subtle','text-danger');
          badge.textContent = 'Inactif';
        }
      } catch (e) {
        // rollback l’état visuel si échec
        this.checked = !checked;
        alert('Impossible de changer le statut : ' + e.message);
      }
    });
  });
});
</script>
{% endblock %}

{% extends 'layouts/main.html.twig' %}
{% block title %}Détail RDV | Velzon
{% endblock %}

{% block page_header %}
	<div class="row">
		<div class="col-12">
			<div class="page-title-box d-sm-flex align-items-center justify-content-between">
				<div>
					<h4 class="mb-sm-0">
						<i class="ri-calendar-2-line"></i>
						Gestion des Rendez-vous
					</h4>
					<p class="text-muted mb-0">Modifier - Payer un rendez-vous</p>
				</div>
				<div class="page-title-right">
					<ol class="breadcrumb m-0">
						<li class="breadcrumb-item">
							<a href="{{ path('admin_dashboard') }}">Dashboard</a>
						</li>
						<li class="breadcrumb-item active">Rendez-vous</li>
					</ol>
				</div>
			</div>
		</div>
	</div>
	<div class="card">
		<div class="card-body">
			<div class="row mb-3 pb-1">
				<div class="row mb-3">
					<div class="col">
						<h4 class="fs-16 mb-1">Détail du rendez-vous</h4>
						<p class="text-muted mb-0">Client & prestation</p>
					</div>
				</div>
			</div>
		</div>
	</div>
{% endblock %}
{% block body %}
	<div class="row">
		<div class="col-lg-8">
			<div class="card">
				<div class="card-body">
					<h5 class="mb-3">Informations</h5>
					<div class="row g-3">
						<div class="col-md-6">
							<strong>Client :</strong>
							{{ rdv.client ? rdv.client.nometprenom : '—' }}</div>
						<div class="col-md-6">
							<strong>Téléphone :</strong>
							{{ rdv.client ? rdv.client.telephone : '—' }}</div>
						<div class="col-md-6">
							<strong>Prestation :</strong>
							{{ rdv.prestation ? rdv.prestation.libelle : '—' }}</div>
						<div class="col-md-6">
							<strong>Prix :</strong>
							{{ rdv.prestation ? (rdv.prestation.prix|number_format(0, ',', ' ') ~ ' MRU') : '—' }}</div>
						<div class="col-md-6">
							<strong>Début :</strong>
							{{ rdv.startAt ? rdv.startAt|date('d/m/Y H:i') : '—' }}</div>
						<div class="col-md-6">
							<strong>Fin :</strong>
							{{ rdv.endAt ? rdv.endAt|date('d/m/Y H:i') : '—' }}</div>
						<div class="col-md-6">
							<strong>Statut :</strong>
							{% set bcl = {'planifie':'bg-warning-subtle text-warning', 'honore':'bg-success-subtle text-success', 'annule':'bg-danger-subtle text-danger'} %}
							<span class="badge {{ bcl[rdv.status|default('planifie')] ?? 'bg-secondary' }}">{{ rdv.status|default('planifie')|capitalize }}</span>
						</div>
						<div class="col-12">
							<strong>Notes :</strong><br>{{ rdv.notes ?: '—' }}</div>
					</div>

					<div class="mt-4 d-flex gap-2">
						<a href="{{ path('app_rdv_edit', {id: rdv.id}) }}" class="btn btn-soft-secondary">
							<i class="ri-pencil-line"></i>
							Modifier</a>
						{% if rdv.prestation %}
							<a href="{{ path('app_payment_new', {rdv: rdv.id}) }}" class="btn btn-success">
								<i class="ri-money-dollar-circle-line"></i>
								Payer</a>
						{% endif %}
						<a href="{{ path('app_rdv_index') }}" class="btn btn-ghost-secondary">Retour</a>
					</div>
				</div>
			</div>
		</div>
		<div class="col-lg-4">
			{# Statut de paiement #}
<div class="card mb-3">
    <div class="card-header">
        <h5>Statut de paiement</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <strong>Montant total :</strong><br>
                {{ rdv.totalAmount|number_format(0, ',', ' ') }} MRU
            </div>
            <div class="col-md-4">
                <strong>Montant payé :</strong><br>
                {{ rdv.totalPaid|number_format(0, ',', ' ') }} MRU
            </div>
            <div class="col-md-4">
                <strong>Reste à payer :</strong><br>
                <span class="text-{{ rdv.remainingAmount > 0 ? 'danger' : 'success' }}">
                    {{ rdv.remainingAmount|number_format(0, ',', ' ') }} MRU
                </span>
            </div>
        </div>
        <div class="mt-3">
            <strong>Statut :</strong>
            {% if rdv.paymentStatus == constant('App\\Entity\\Rdv::PS_PAYE') %}
                <span class="badge bg-success">Payé</span>
            {% elseif rdv.paymentStatus == constant('App\\Entity\\Rdv::PS_PARTIEL') %}
                <span class="badge bg-warning">Partiellement payé</span>
            {% else %}
                <span class="badge bg-secondary">Non payé</span>
            {% endif %}
        </div>

        {# Afficher les paiements #}
        {% if rdv.payments|length > 0 %}
            <hr>
            <h6>Historique des paiements</h6>
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Montant</th>
                        <th>Méthode</th>
                        <th>Type</th>
                        <th>Reçu</th>
                    </tr>
                </thead>
                <tbody>
                    {% for payment in rdv.payments %}
                        <tr>
                            <td>{{ payment.paidAt|date('d/m/Y H:i') }}</td>
                            <td>{{ payment.amount|number_format(0, ',', ' ') }} MRU</td>
                            <td>{{ payment.methode }}</td>
                            <td>
                                {% if payment.isDeposit %}
                                    <span class="badge bg-info">Acompte</span>
                                {% else %}
                                    <span class="badge bg-success">Paiement final</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ path('app_payment_show', {id: payment.id}) }}" class="btn btn-sm btn-primary">
                                    Voir
                                </a>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% endif %}

        {# Bouton pour ajouter un paiement #}
        {% if rdv.remainingAmount > 0 %}
            <div class="mt-3">
                <a href="{{ path('app_payment_new', {rdv: rdv.id}) }}" class="btn btn-success">
                    {% if rdv.totalPaid > 0 %}
                        Verser le reste ({{ rdv.remainingAmount|number_format(0, ',', ' ') }} MRU)
                    {% else %}
                        Enregistrer un paiement
                    {% endif %}
                </a>
            </div>
        {% endif %}
    </div>
</div>

	</div>
{% endblock %}

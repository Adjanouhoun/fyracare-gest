{% extends 'layouts/main.html.twig' %}

{% block title %}Paiements partiels{% endblock %}

{% macro status_badge(s) %}
	{% set map = {
    'HONORE':   'bg-success-subtle text-success',
    'CONFIRME': 'bg-primary-subtle text-primary',
    'ANNULE':   'bg-danger-subtle text-danger',
    'ABSENT':   'bg-warning-subtle text-warning',
    'PLANIFIE': 'bg-info-subtle text-info'
  } %}
	<span class="badge {{ map[s] ?? 'bg-secondary-subtle text-secondary' }}">{{ s }}</span>
{% endmacro %}

{% block stylesheets %}
<style>
.payment-progress {
    height: 8px;
    border-radius: 4px;
    background-color: #f0f0f0;
    overflow: hidden;
}
.payment-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #ffc107 0%, #ff9800 100%);
    transition: width 0.3s ease;
}
</style>
{% endblock %}

{% block page_header %}
	<div class="row">
		<div class="col-12">
			<div class="page-title-box d-sm-flex align-items-center justify-content-between">
				<div>
					<h4 class="mb-sm-0">
						<i class="ri-alert-line text-warning"></i>
						Paiements à compléter
					</h4>
					<p class="text-muted mb-0">Rendez-vous avec paiements partiels</p>
				</div>
				<div class="page-title-right">
					<ol class="breadcrumb m-0">
						<li class="breadcrumb-item">
							<a href="{{ path('admin_dashboard') }}">Dashboard</a>
						</li>
						<li class="breadcrumb-item">
							<a href="{{ path('app_rdv_all') }}">Rendez-vous</a>
						</li>
						<li class="breadcrumb-item active">Paiements partiels</li>
					</ol>
				</div>
			</div>
		</div>
	</div>
{% endblock %}

{% block body %}
	{# Carte statistiques #}
	<div class="row mb-3">
		<div class="col-12">
			<div class="card bg-warning-subtle border-warning">
				<div class="card-body">
					<div class="row align-items-center">
						<div class="col-auto">
							<div class="avatar-lg">
								<span class="avatar-title bg-warning text-white rounded-circle fs-1">
									<i class="ri-alert-line"></i>
								</span>
							</div>
						</div>
						<div class="col">
							<h5 class="mb-1">
								{{ pagination.getTotalItemCount }} rendez-vous en attente de paiement complet
							</h5>
							<p class="text-muted mb-0">
								<i class="ri-information-line me-1"></i>
								Ces rendez-vous ont reçu un acompte et nécessitent un complément de paiement.
							</p>
						</div>
						<div class="col-auto">
							<a href="{{ path('app_rdv_all') }}" class="btn btn-warning">
								<i class="ri-arrow-left-line me-1"></i>
								Retour aux RDV
							</a>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	{# Liste des RDV #}
	<div class="card">
		<div class="card-header">
			<div class="d-flex align-items-center justify-content-between">
				<h5 class="card-title mb-0">
					<i class="ri-list-check-2 me-2"></i>
					Liste des paiements incomplets
				</h5>
				<div class="d-flex gap-2">
					<a href="{{ path('app_rdv_index') }}" class="btn btn-soft-secondary btn-sm">
						<i class="ri-calendar-check-line me-1"></i>
						RDV du jour
					</a>
					<a href="{{ path('app_rdv_all') }}" class="btn btn-soft-secondary btn-sm">
						<i class="ri-calendar-2-line me-1"></i>
						Tous les RDV
					</a>
				</div>
			</div>
		</div>

		<div class="card-body">
			{% if pagination|length > 0 %}
				<div class="table-responsive table-card">
					<table class="table table-hover align-middle table-nowrap mb-0">
						<thead class="table-light">
							<tr>
								<th style="width: 50px;">#</th>
								<th>Client</th>
								<th>Prestation</th>
								<th>Date RDV</th>
								<th>Statut</th>
								<th>Montant Total</th>
								<th>Payé</th>
								<th class="text-danger">Restant</th>
								<th>Progression</th>
								<th class="text-end">Actions</th>
							</tr>
						</thead>
						<tbody>
							{% for rdv in pagination %}
								{% set percentPaid = rdv.totalAmount > 0 ? (rdv.totalPaid / rdv.totalAmount * 100)|round : 0 %}
								<tr class="table-warning">
									<td>
										<span class="badge bg-warning-subtle text-warning fs-13">
											#{{ rdv.id }}
										</span>
									</td>
									<td>
										<div class="d-flex align-items-center">
											<div class="avatar-xs me-2">
												<span class="avatar-title rounded-circle bg-warning-subtle text-warning">
													<i class="ri-user-line"></i>
												</span>
											</div>
											<div>
												<h6 class="mb-0">{{ rdv.client.nometprenom }}</h6>
												<small class="text-muted">
													<i class="ri-phone-line me-1"></i>
													{{ rdv.client.telephone }}
												</small>
											</div>
										</div>
									</td>
									<td>
										<span class="fw-medium">{{ rdv.prestation.libelle }}</span>
										<br>
										<small class="text-muted">{{ rdv.prestation.dureeMin }} min</small>
									</td>
									<td>
										<span class="text-muted">{{ rdv.startAt ? rdv.startAt|date('d/m/Y') : '—' }}</span>
										<br>
										<small class="text-muted">{{ rdv.startAt ? rdv.startAt|date('H:i') : '—' }}</small>
									</td>
									<td>
										{{ _self.status_badge(rdv.status) }}
									</td>
									<td>
										<span class="fw-semibold">{{ rdv.totalAmount|number_format(0, ',', ' ') }}</span>
										<small class="text-muted">MRU</small>
									</td>
									<td>
										<span class="text-success fw-medium">{{ rdv.totalPaid|number_format(0, ',', ' ') }}</span>
										<small class="text-muted">MRU</small>
										<br>
										<small class="text-muted">{{ rdv.payments|length }} paiement(s)</small>
									</td>
									<td>
										<span class="badge bg-danger fs-13">
											{{ rdv.remainingAmount|number_format(0, ',', ' ') }} MRU
										</span>
									</td>
									<td style="min-width: 120px;">
										<div class="payment-progress mb-1">
											<div class="payment-progress-bar" style="width: {{ percentPaid }}%"></div>
										</div>
										<small class="text-muted">{{ percentPaid|round }}% payé</small>
									</td>
									<td class="text-end">
										<div class="btn-group">
											<a class="btn btn-sm btn-soft-secondary" href="{{ path('app_rdv_show', {id: rdv.id}) }}" title="Détails">
												<i class="ri-eye-line"></i>
											</a>
											<a class="btn btn-sm btn-soft-info" href="{{ path('app_rdv_edit', {id: rdv.id}) }}" title="Modifier">
												<i class="ri-pencil-line"></i>
											</a>
											<a class="btn btn-sm btn-warning" href="{{ path('app_payment_new', { rdv: rdv.id }) }}" title="Compléter le paiement">
												<i class="ri-cash-line me-1"></i>
												Payer
											</a>
										</div>
									</td>
								</tr>
							{% endfor %}
						</tbody>
						<tfoot class="table-light">
							<tr>
								<td colspan="5" class="text-end fw-bold">Totaux :</td>
								<td>
									<span class="fw-bold">
										{% set totalAmount = 0 %}
										{% for rdv in pagination %}
											{% set totalAmount = totalAmount + rdv.totalAmount %}
										{% endfor %}
										{{ totalAmount|number_format(0, ',', ' ') }} MRU
									</span>
								</td>
								<td>
									<span class="fw-bold text-success">
										{% set totalPaid = 0 %}
										{% for rdv in pagination %}
											{% set totalPaid = totalPaid + rdv.totalPaid %}
										{% endfor %}
										{{ totalPaid|number_format(0, ',', ' ') }} MRU
									</span>
								</td>
								<td>
									<span class="fw-bold text-danger">
										{% set totalRemaining = 0 %}
										{% for rdv in pagination %}
											{% set totalRemaining = totalRemaining + rdv.remainingAmount %}
										{% endfor %}
										{{ totalRemaining|number_format(0, ',', ' ') }} MRU
									</span>
								</td>
								<td colspan="2"></td>
							</tr>
						</tfoot>
					</table>
				</div>

				<div class="mt-3">
					{{ knp_pagination_render(pagination) }}
				</div>
			{% else %}
				<div class="alert alert-success border-success text-center mb-0">
					<i class="ri-check-double-line fs-1 mb-3"></i>
					<h5>Aucun paiement en attente</h5>
					<p class="text-muted mb-0">Tous les rendez-vous sont soit entièrement payés, soit non payés.</p>
					<div class="mt-3">
						<a href="{{ path('app_rdv_all') }}" class="btn btn-success">
							<i class="ri-arrow-left-line me-1"></i>
							Retour aux rendez-vous
						</a>
					</div>
				</div>
			{% endif %}
		</div>
	</div>

	{# Aide #}
	{% if pagination|length > 0 %}
	<div class="row mt-3">
		<div class="col-12">
			<div class="card border-info">
				<div class="card-body">
					<div class="d-flex">
						<div class="flex-shrink-0">
							<i class="ri-information-line text-info fs-2 me-3"></i>
						</div>
						<div class="flex-grow-1">
							<h6 class="mb-2">
								<i class="ri-lightbulb-line me-1"></i>
								Conseils pour gérer les paiements partiels
							</h6>
							<ul class="mb-0 text-muted">
								<li>Contactez les clients pour leur rappeler le solde restant</li>
								<li>Vérifiez la date du rendez-vous : priorité aux RDV les plus anciens</li>
								<li>Utilisez le bouton "Payer" pour enregistrer le complément</li>
								<li>Consultez l'historique des paiements dans le détail du RDV</li>
							</ul>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	{% endif %}
{% endblock %}
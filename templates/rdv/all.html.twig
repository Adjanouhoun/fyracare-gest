{% extends 'layouts/main.html.twig' %}

{% block title %}Tous les rendez-vous{% endblock %}

{% macro status_badge(s) %}
  {% set map = {
    'HONORE':   'bg-success-subtle text-success',
    'CONFIRME': 'bg-primary-subtle text-primary',
    'ANNULE':   'bg-danger-subtle text-danger',
    'ABSENT':   'bg-warning-subtle text-warning'
  } %}
  <span class="badge {{ map[s] ?? 'bg-info-subtle text-info' }}">{{ s }}</span>
{% endmacro %}

{% block body %}
<div class="page-content">
  <div class="container-fluid">

    <div class="row mb-3">
      <div class="col">
        <h4 class="fs-16 mb-1">Tous les rendez-vous</h4>
        <p class="text-muted mb-0">Filtre par statut et recherche.</p>
      </div>
      <div class="col-auto d-flex gap-2">
        <a href="{{ path('app_rdv_index') }}" class="btn btn-soft-secondary">
          <i class="ri-calendar-check-line align-middle me-1"></i> RDV du jour
        </a>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <form method="get" class="row g-2 align-items-end">
          <div class="col-md-3">
            <label class="form-label">Statut</label>
            <select name="status" class="form-select">
              <option value="">— Tous —</option>
              {% for st in statuses %}
                <option value="{{ st }}" {% if status == st %}selected{% endif %}>{{ st }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-5">
            <label class="form-label">Recherche (client / prestation / téléphone)</label>
            <input type="text" name="q" value="{{ q }}" class="form-control" placeholder="Ex: Diallo, coupe, 0700…">
          </div>
          <div class="col-md-4">
            <button class="btn btn-primary w-100">
              <i class="ri-search-line align-middle me-1"></i> Filtrer
            </button>
          </div>
        </form>
      </div>

      <div class="card-body">
        {% if pagination|length > 0 %}
          <div class="table-responsive table-card">
            <table class="table table-hover align-middle table-nowrap mb-0">
              <thead class="table-light">
                <tr>
                  <th>Date</th>
                  <th>Heure</th>
                  <th>Client</th>
                  <th>Prestation</th>
                  <th>Statut</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for rdv in pagination %}
                {% set dejaPaye = rdv.isPaid() %}
                  <tr>
                    <td>{{ rdv.startAt ? rdv.startAt|date('d/m/Y') : '—' }}</td>
                    <td>
                      {{ rdv.startAt ? rdv.startAt|date('H:i') : '—' }}
                      {% if rdv.endAt %}– {{ rdv.endAt|date('H:i') }}{% endif %}
                    </td>
                    <td>{{ rdv.client }}</td>
                    <td>{{ rdv.prestation }}</td>
                    <td>{{ _self.status_badge(rdv.status) }}</td>
                    <td class="text-end">
                      <div class="btn-group">
                        <a class="btn btn-sm btn-soft-secondary" href="{{ path('app_rdv_show', {id: rdv.id}) }}"><i class="ri-eye-line"></i></a>
                        <a class="btn btn-sm btn-soft-info" href="{{ path('app_rdv_edit', {id: rdv.id}) }}"><i class="ri-pencil-line"></i></a>
                        <a class="btn btn-sm btn-soft-success {{ dejaPaye ? 'disabled' : '' }}"
                          {% if not dejaPaye %}
                            href="{{ path('app_payment_new', { rdv: rdv.id }) }}"
                          {% else %}
                            href="#" tabindex="-1" aria-disabled="true" title="Déjà payé"
                          {% endif %}>
                          <i class="ri-cash-line"></i>
                        </a>
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="mt-3">
            {{ knp_pagination_render(pagination) }}
          </div>
        {% else %}
          <div class="text-muted">Aucun rendez-vous trouvé.</div>
        {% endif %}
      </div>
    </div>

  </div>
</div>
{% endblock %}

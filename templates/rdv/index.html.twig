{% extends 'layouts/main.html.twig' %}

{% block title %}Rendez-vous{% endblock %}

{% macro status_badge(s) %}
	{% set map = {
    'HONORE':   'bg-success-subtle text-success',
    'CONFIRME': 'bg-primary-subtle text-primary',
    'ANNULE':   'bg-danger-subtle text-danger',
    'ABSENT':   'bg-warning-subtle text-warning',
    'PLANIFIE': 'bg-info-subtle text-info'
  } %}
	<span class="badge {{ map[s] ?? 'bg-info-subtle text-info' }}">{{ s }}</span>
{% endmacro %}

{% macro payment_badge(rdv) %}
	{% if rdv.paymentStatus == constant('App\\Entity\\Rdv::PS_PAYE') %}
		<i class="ri-check-double-fill text-success fs-5" title="Payé"></i>
	{% elseif rdv.paymentStatus == constant('App\\Entity\\Rdv::PS_PARTIEL') %}
		<i class="ri-error-warning-fill text-warning fs-5" title="Paiement partiel"></i>
	{% else %}
		<i class="ri-close-circle-fill text-secondary fs-5" title="Non payé"></i>
	{% endif %}
{% endmacro %}

{% block page_header %}
	<div class="row">
		<div class="col-12">
			<div class="page-title-box d-sm-flex align-items-center justify-content-between">
				<div>
					<h4 class="mb-sm-0">
						<i class="ri-calendar-2-line"></i>
						Gestion des Rendez-vous
					</h4>
					<p class="text-muted mb-0">RDV du jour et rendez-vous impayés</p>
				</div>
				<div class="page-title-right">
					<ol class="breadcrumb m-0">
						<li class="breadcrumb-item">
							<a href="{{ path('admin_dashboard') }}">Dashboard</a>
						</li>
						<li class="breadcrumb-item active">Rendez-vous</li>
					</ol>
				</div>
			</div>
		</div>
	</div>
{% endblock %}

{% block body %}
	{# Boutons de navigation #}
	<div class="row mb-3">
		<div class="col-12">
			<div class="card">
				<div class="card-body">
					<div class="d-flex justify-content-between align-items-center">
						<div>
							<h5 class="mb-0">Filtrer les rendez-vous</h5>
						</div>
						<div class="d-flex gap-2">
							<a href="{{ path('app_rdv_partial_payments') }}" class="btn btn-warning">
								<i class="ri-alert-line me-1"></i>
								Paiements partiels
							</a>
							<a href="{{ path('app_rdv_all') }}" class="btn btn-info">
								<i class="ri-list-check-2 me-1"></i>
								Tous les RDV
							</a>
							<a href="{{ path('app_rdv_new') }}" class="btn btn-success">
								<i class="ri-add-line me-1"></i>
								Nouveau RDV
							</a>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	{# Formulaire de filtres #}
	<div class="card">
		<div class="card-header bg-light">
			<form method="get" class="row g-3 align-items-end">
				<div class="col-md-3">
					<label class="form-label fw-semibold">Statut RDV</label>
					<select name="status" class="form-select">
						<option value="">— Tous les statuts —</option>
						{% for st in statuses %}
							<option value="{{ st }}" {% if status == st %}selected{% endif %}>{{ st }}</option>
						{% endfor %}
					</select>
				</div>
				<div class="col-md-5">
					<label class="form-label fw-semibold">Recherche</label>
					<input type="text" name="q" value="{{ q }}" class="form-control" placeholder="Client, prestation, téléphone...">
				</div>
				<div class="col-md-4">
					<button type="submit" class="btn btn-primary w-100">
						<i class="ri-search-line me-1"></i>
						Rechercher
					</button>
				</div>
			</form>
		</div>

		<div class="card-body">
			{% if pagination|length > 0 %}
				<div class="alert alert-info border-0 mb-3">
					<div class="d-flex align-items-center">
						<i class="ri-information-line fs-4 me-2"></i>
						<div>
							<strong>Affichage par défaut :</strong> RDV du jour + RDV impayés de toutes les dates
						</div>
					</div>
				</div>

				<div class="table-responsive table-card">
					<table class="table table-hover align-middle table-nowrap mb-0">
						<thead class="table-light">
							<tr>
								<th>Date</th>
								<th>Heure</th>
								<th>Client</th>
								<th>Prestation</th>
								<th>Statut RDV</th>
								<th class="text-center">Paiement</th>
								<th class="text-end">Actions</th>
							</tr>
						</thead>
						<tbody>
							{% for rdv in pagination %}
								<tr class="{{ rdv.paymentStatus == constant('App\\Entity\\Rdv::PS_PARTIEL') ? 'table-warning' : (rdv.paymentStatus == constant('App\\Entity\\Rdv::PS_NON_PAYE') ? 'table-danger' : '') }}">
									<td>
										<span class="fw-medium">{{ rdv.startAt ? rdv.startAt|date('d/m/Y') : '—' }}</span>
										{% if rdv.startAt %}
											<br><small class="text-muted">{{ rdv.startAt|date('l') }}</small>
										{% endif %}
									</td>
									<td>
										<strong>{{ rdv.startAt ? rdv.startAt|date('H:i') : '—' }}</strong>
										{% if rdv.endAt %}
											<br><small class="text-muted">{{ rdv.endAt|date('H:i') }}</small>
										{% endif %}
									</td>
									<td>
										<div class="d-flex align-items-center">
											<div class="avatar-xs me-2">
												<span class="avatar-title rounded-circle bg-primary-subtle text-primary">
													{{ rdv.client.nometprenom|slice(0,1)|upper }}
												</span>
											</div>
											<div>
												<h6 class="mb-0">{{ rdv.client.nometprenom }}</h6>
												<small class="text-muted">{{ rdv.client.telephone }}</small>
											</div>
										</div>
									</td>
									<td>
										<span class="fw-medium">{{ rdv.prestation.libelle }}</span><br>
										<small class="text-muted">{{ rdv.prestation.prix|number_format(0, ',', ' ') }} MRU</small>
									</td>
									<td>{{ _self.status_badge(rdv.status) }}</td>
									<td class="text-center">
										{{ _self.payment_badge(rdv) }}
										{% if rdv.paymentStatus == constant('App\\Entity\\Rdv::PS_PARTIEL') %}
											<br><small class="badge bg-warning-subtle text-warning">
												Reste: {{ rdv.remainingAmount|number_format(0, ',', ' ') }} MRU
											</small>
										{% elseif rdv.paymentStatus == constant('App\\Entity\\Rdv::PS_NON_PAYE') %}
											<br><small class="badge bg-danger-subtle text-danger">
												{{ rdv.totalAmount|number_format(0, ',', ' ') }} MRU
											</small>
										{% endif %}
									</td>
									<td class="text-end">
										<div class="btn-group">
											<a class="btn btn-sm btn-soft-secondary" href="{{ path('app_rdv_show', {id: rdv.id}) }}" title="Détails">
												<i class="ri-eye-line"></i>
											</a>
											<a class="btn btn-sm btn-soft-info" href="{{ path('app_rdv_edit', {id: rdv.id}) }}" title="Modifier">
												<i class="ri-pencil-line"></i>
											</a>
											{% if rdv.remainingAmount > 0 %}
												<a class="btn btn-sm btn-{{ rdv.totalPaid > 0 ? 'warning' : 'success' }}" href="{{ path('app_payment_new', { rdv: rdv.id }) }}" title="Payer">
													<i class="ri-cash-line"></i>
												</a>
											{% else %}
												<a class="btn btn-sm btn-soft-success disabled" href="#" title="Payé">
													<i class="ri-check-line"></i>
												</a>
											{% endif %}
										</div>
									</td>
								</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>

				<div class="mt-3">
					{{ knp_pagination_render(pagination) }}
				</div>
			{% else %}
				<div class="alert alert-success border-success text-center mb-0">
					<i class="ri-check-double-line fs-1 mb-3"></i>
					<h5>Aucun rendez-vous trouvé</h5>
					<p class="text-muted mb-3">
						{% if q or status %}
							Aucun rendez-vous ne correspond à vos critères de recherche.
						{% else %}
							Pas de RDV aujourd'hui et aucun RDV impayé.
						{% endif %}
					</p>
					<a href="{{ path('app_rdv_new') }}" class="btn btn-success">
						<i class="ri-add-line me-1"></i>
						Créer un rendez-vous
					</a>
				</div>
			{% endif %}
		</div>
	</div>

	{# Légende #}
	<div class="row mt-3">
		<div class="col-12">
			<div class="card border-info">
				<div class="card-body">
					<h6 class="mb-2">
						<i class="ri-information-line me-1"></i>
						Légende des couleurs
					</h6>
					<div class="d-flex flex-wrap gap-3">
						<div class="d-flex align-items-center">
							<div class="bg-danger" style="width: 20px; height: 20px; border-radius: 4px;"></div>
							<span class="ms-2">RDV non payé</span>
						</div>
						<div class="d-flex align-items-center">
							<div class="bg-warning" style="width: 20px; height: 20px; border-radius: 4px;"></div>
							<span class="ms-2">RDV partiellement payé</span>
						</div>
						<div class="d-flex align-items-center">
							<i class="ri-check-double-fill text-success fs-4"></i>
							<span class="ms-2">RDV entièrement payé</span>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
{% endblock %}